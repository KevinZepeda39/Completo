<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= titulo %></title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background-color: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 0 5px 5px 0;
        }
        .log-error { border-left-color: #dc3545; background-color: #f8d7da; }
        .log-warning { border-left-color: #ffc107; background-color: #fff3cd; }
        .log-info { border-left-color: #17a2b8; background-color: #d1ecf1; }
        .log-success { border-left-color: #28a745; background-color: #d4edda; }
        .log-debug { border-left-color: #6c757d; background-color: #e2e3e5; }
        .badge-level {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .level-error { background-color: #dc3545; color: white; }
        .level-warning { background-color: #ffc107; color: black; }
        .level-info { background-color: #17a2b8; color: white; }
        .level-success { background-color: #28a745; color: white; }
        .level-debug { background-color: #6c757d; color: white; }
        .auto-refresh {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="/images/logo.png" alt="MiCiudadSV" class="img-fluid mb-2" style="max-width: 80px;" onerror="this.style.display='none'">
                        <h5 class="text-white">Admin Panel</h5>
                        <small class="text-light opacity-75">
                            Bienvenido, <%= usuario.nombre %>
                        </small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="/admin">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="/admin/usuarios">
                                <i class="fas fa-users me-2"></i>
                                Gestionar Usuarios
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="/admin/reportes">
                                <i class="fas fa-flag me-2"></i>
                                Ver Reportes
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="/admin/comunidades">
                                <i class="fas fa-home me-2"></i>
                                Comunidades
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link active" href="/admin/logs">
                                <i class="fas fa-file-alt me-2"></i>
                                Ver Logs
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="/admin/configuracion">
                                <i class="fas fa-cog me-2"></i>
                                Configuración
                            </a>
                        </li>
                        <hr class="text-light">
                        <li class="nav-item">
                            <a class="nav-link" href="/auth/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>
                                Cerrar Sesión
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-file-alt me-2"></i>
                        Logs del Sistema
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="actualizarLogs()">
                                <i class="fas fa-sync-alt" id="iconRefresh"></i> Actualizar
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="toggleAutoRefresh()" id="btnAutoRefresh">
                                <i class="fas fa-play"></i> Auto-Actualizar
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-danger" onclick="limpiarLogs()" title="Limpiar logs antiguos">
                                <i class="fas fa-trash"></i> Limpiar
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="exportarLogs()" title="Exportar logs">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filtros y controles -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-filter me-2"></i>
                        Filtros y Configuración
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="filtroNivel" class="form-label">Nivel:</label>
                                <select id="filtroNivel" class="form-select" onchange="filtrarLogs()">
                                    <option value="">Todos los niveles</option>
                                    <option value="error">Error</option>
                                    <option value="warning">Warning</option>
                                    <option value="info">Info</option>
                                    <option value="success">Success</option>
                                    <option value="debug">Debug</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="filtroAccion" class="form-label">Acción:</label>
                                <select id="filtroAccion" class="form-select" onchange="filtrarLogs()">
                                    <option value="">Todas las acciones</option>
                                    <option value="login">Login</option>
                                    <option value="logout">Logout</option>
                                    <option value="registro">Registro</option>
                                    <option value="reporte">Reporte</option>
                                    <option value="admin">Admin</option>
                                    <option value="error">Error</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="filtroUsuario" class="form-label">Usuario:</label>
                                <input type="text" id="filtroUsuario" class="form-control" placeholder="Buscar por usuario..." onchange="filtrarLogs()">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="filtroFecha" class="form-label">Fecha:</label>
                                <input type="date" id="filtroFecha" class="form-control" onchange="filtrarLogs()">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="limiteLogs" class="form-label">Mostrar últimos:</label>
                                <select id="limiteLogs" class="form-select" onchange="cargarLogs()">
                                    <option value="50">50 logs</option>
                                    <option value="100" selected>100 logs</option>
                                    <option value="200">200 logs</option>
                                    <option value="500">500 logs</option>
                                    <option value="1000">1000 logs</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Acciones rápidas:</label>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-danger me-2" onclick="mostrarSoloErrores()">
                                        Solo Errores
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="mostrarLoginsRecientes()">
                                        Logins Recientes
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limpiarFiltros()">
                                        Limpiar Filtros
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas rápidas -->
                <div class="row mb-4">
                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="card border-left-danger shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Errores (24h)</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="errores24h">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="card border-left-warning shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Warnings (24h)</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="warnings24h">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-exclamation-circle fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Logins (24h)</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="logins24h">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-sign-in-alt fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="card border-left-info shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Registros (24h)</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="registros24h">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-user-plus fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Reportes (24h)</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="reportes24h">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-flag fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="card border-left-secondary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">Total Logs</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalLogs">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-list fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logs en tiempo real -->
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-stream me-2"></i>
                                Logs del Sistema
                                <span class="badge bg-secondary ms-2" id="contadorLogs">0 logs</span>
                            </div>
                            <div>
                                <small class="text-muted">
                                    Última actualización: <span id="ultimaActualizacion">--:--:--</span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;" id="contenedorLogs">
                        <div id="logsContainer">
                            <!-- Los logs se cargarán aquí dinámicamente -->
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando logs...</span>
                                </div>
                                <p class="text-muted mt-2">Cargando logs del sistema...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let autoRefreshInterval = null;
        let logsData = [];

        // Cargar logs al inicio
        document.addEventListener('DOMContentLoaded', function() {
            cargarLogs();
            cargarEstadisticas();
        });

        // Función para cargar logs
        async function cargarLogs() {
            try {
                const limite = document.getElementById('limiteLogs').value;
                const response = await fetch(`/admin/api/logs?limite=${limite}`);
                
                if (!response.ok) {
                    throw new Error('Error al cargar logs');
                }
                
                const data = await response.json();
                logsData = data.logs || [];
                mostrarLogs(logsData);
                actualizarContadores();
                
                // Actualizar timestamp
                document.getElementById('ultimaActualizacion').textContent = 
                    new Date().toLocaleTimeString('es-SV');
                    
            } catch (error) {
                console.error('Error cargando logs:', error);
                document.getElementById('logsContainer').innerHTML = 
                    '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error al cargar los logs del sistema</div>';
            }
        }

        // Función para mostrar logs
        function mostrarLogs(logs) {
            const container = document.getElementById('logsContainer');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No hay logs para mostrar</p>
                        <button class="btn btn-primary" onclick="cargarLogs()">
                            <i class="fas fa-sync-alt"></i> Recargar
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            logs.forEach(log => {
                const fecha = new Date(log.fecha).toLocaleString('es-SV');
                const nivel = log.nivel || 'info';
                const accion = log.accion || 'Sistema';
                const usuario = log.usuario || 'Sistema';
                const ip = log.ip || '--';
                const mensaje = log.mensaje || log.descripcion || 'Sin mensaje';
                
                html += `
                    <div class="log-entry log-${nivel}" data-nivel="${nivel}" data-accion="${accion}" data-usuario="${usuario}" data-fecha="${log.fecha}">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <div>
                                <span class="badge badge-level level-${nivel}">${nivel.toUpperCase()}</span>
                                <strong>${accion}</strong>
                                <span class="text-muted">| ${usuario}</span>
                                <span class="text-muted">| ${ip}</span>
                            </div>
                            <small class="text-muted">${fecha}</small>
                        </div>
                        <div class="log-message">${mensaje}</div>
                        ${log.detalles ? `<div class="text-muted mt-1"><small>Detalles: ${log.detalles}</small></div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Función para cargar estadísticas
        async function cargarEstadisticas() {
            try {
                const response = await fetch('/admin/api/logs/estadisticas');
                const data = await response.json();
                
                document.getElementById('errores24h').textContent = data.errores24h || 0;
                document.getElementById('warnings24h').textContent = data.warnings24h || 0;
                document.getElementById('logins24h').textContent = data.logins24h || 0;
                document.getElementById('registros24h').textContent = data.registros24h || 0;
                document.getElementById('reportes24h').textContent = data.reportes24h || 0;
                document.getElementById('totalLogs').textContent = data.totalLogs || 0;
                
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        // Función para actualizar contadores
        function actualizarContadores() {
            const total = logsData.length;
            document.getElementById('contadorLogs').textContent = `${total} logs`;
        }

        // Función para actualizar logs
        function actualizarLogs() {
            const icon = document.getElementById('iconRefresh');
            icon.classList.add('fa-spin');
            
            cargarLogs().finally(() => {
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                }, 500);
            });
        }

        // Función para toggle auto-refresh
        function toggleAutoRefresh() {
            const btn = document.getElementById('btnAutoRefresh');
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.innerHTML = '<i class="fas fa-play"></i> Auto-Actualizar';
                btn.classList.remove('auto-refresh');
            } else {
                autoRefreshInterval = setInterval(cargarLogs, 10000); // Cada 10 segundos
                btn.innerHTML = '<i class="fas fa-pause"></i> Detener Auto';
                btn.classList.add('auto-refresh');
            }
        }

        // Función para filtrar logs
        function filtrarLogs() {
            const filtroNivel = document.getElementById('filtroNivel').value;
            const filtroAccion = document.getElementById('filtroAccion').value;
            const filtroUsuario = document.getElementById('filtroUsuario').value.toLowerCase();
            const filtroFecha = document.getElementById('filtroFecha').value;
            
            const logsFiltrados = logsData.filter(log => {
                let cumple = true;
                
                if (filtroNivel && log.nivel !== filtroNivel) {
                    cumple = false;
                }
                
                if (filtroAccion && !log.accion.toLowerCase().includes(filtroAccion.toLowerCase())) {
                    cumple = false;
                }
                
                if (filtroUsuario && !log.usuario.toLowerCase().includes(filtroUsuario)) {
                    cumple = false;
                }
                
                if (filtroFecha) {
                    const fechaLog = new Date(log.fecha).toISOString().split('T')[0];
                    if (fechaLog !== filtroFecha) {
                        cumple = false;
                    }
                }
                
                return cumple;
            });
            
            mostrarLogs(logsFiltrados);
        }

        // Funciones de filtros rápidos
        function mostrarSoloErrores() {
            document.getElementById('filtroNivel').value = 'error';
            filtrarLogs();
        }

        function mostrarLoginsRecientes() {
            document.getElementById('filtroAccion').value = 'login';
            document.getElementById('filtroFecha').value = new Date().toISOString().split('T')[0];
            filtrarLogs();
        }

        function limpiarFiltros() {
            document.getElementById('filtroNivel').value = '';
            document.getElementById('filtroAccion').value = '';
            document.getElementById('filtroUsuario').value = '';
            document.getElementById('filtroFecha').value = '';
            mostrarLogs(logsData);
        }

        // Función para limpiar logs
        function limpiarLogs() {
            if (confirm('¿Estás seguro de que deseas limpiar los logs antiguos (más de 30 días)?\n\nEsta acción no se puede deshacer.')) {
                fetch('/admin/api/logs/limpiar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Se eliminaron ${data.eliminados} logs antiguos`);
                        cargarLogs();
                        cargarEstadisticas();
                    } else {
                        alert('Error al limpiar logs: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al limpiar logs');
                });
            }
        }

        // Función para exportar logs
        function exportarLogs() {
            const fecha = new Date().toISOString().split('T')[0];
            window.open(`/admin/api/logs/exportar?fecha=${fecha}`, '_blank');
        }

        // Limpiar interval al salir
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
    
</body>
</html>