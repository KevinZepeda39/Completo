<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiCiudadSV - Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Sistema de Temas -->
    <link href="/css/themes.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Socket.io -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .sidebar {
            background: linear-gradient(180deg, var(--primary-color) 0%, #34495e 100%);
            min-height: 100vh;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar .nav-link {
            color: #ecf0f1;
            border-radius: 8px;
            margin: 5px 15px;
            transition: all 0.3s ease;
        }
        
        .sidebar .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }
        
        .sidebar .nav-link.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--secondary-color), #5dade2);
            color: white;
        }
        
        .stat-card.success {
            background: linear-gradient(135deg, var(--success-color), #58d68d);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning-color), #f7dc6f);
        }
        
        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
        }
        
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .activity-item {
            border-left: 4px solid var(--secondary-color);
            padding-left: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .activity-item:hover {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 10px 15px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-0">
                <div class="p-4">
                    <h4 class="text-white mb-4">
                        <i class="fas fa-city me-2"></i>
                        MiCiudadSV
                    </h4>
                </div>
                
                <nav class="nav flex-column">
                    <a class="nav-link active" href="/">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    <a class="nav-link" href="/dashboard">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    <a class="nav-link" href="/comunidades">
                        <i class="fas fa-users-cog me-2"></i>
                        Comunidades
                    </a>
                    <a class="nav-link" href="/chat-global">
                        <i class="fas fa-comments me-2"></i>
                        Chat Global
                    </a>
                    <a class="nav-link" href="/reportes">
                        <i class="fas fa-chart-bar me-2"></i>
                        Reportes
                    </a>
                    <a class="nav-link" href="/informacion">
                        <i class="fas fa-info-circle me-2"></i>
                        Información
                    </a>
                </nav>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-10">
                <!-- Top Navbar -->
                <nav class="navbar navbar-expand-lg mb-4">
                    <div class="container-fluid">
                        <h1 class="navbar-brand mb-0 h1">Dashboard</h1>
                        
                        <div class="navbar-nav ms-auto">
                            <!-- Botón de cambio de tema -->
                            <div class="nav-item me-3">
                                <button type="button" class="btn btn-outline-secondary btn-sm theme-toggle-btn" id="theme-toggle" title="Cambiar tema">
                                    <i class="fas fa-moon"></i>
                                </button>
                            </div>
                            <div class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                    <div class="user-avatar me-2">
                                        <%= usuario.nombre.charAt(0).toUpperCase() %>
                                    </div>
                                    <%= usuario.nombre %>
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/dashboard"><i class="fas fa-user me-2"></i>Dashboard</a></li>
                                    <li><a class="dropdown-item" href="/dashboard/perfil"><i class="fas fa-user me-2"></i>Ver Perfil</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form action="/auth/logout" method="POST">
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>
                
                <!-- Contenido Principal -->
                <div class="p-4">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <h5 class="card-title">Usuarios Registrados</h5>
                                    <h2 class="card-text" id="usuarios-count">1,234</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card success">
                                <div class="card-body">
                                    <h5 class="card-title">Comunidades Activas</h5>
                                    <h2 class="card-text" id="comunidades-count">456</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card warning">
                                <div class="card-body">
                                    <h5 class="card-title">Mensajes Enviados</h5>
                                    <h2 class="card-text" id="mensajes-count">789</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card danger">
                                <div class="card-body">
                                    <h5 class="card-title">Reportes Generados</h5>
                                    <h2 class="card-text" id="reportes-count">321</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title">Actividad Reciente</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="activityChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title">Últimos Mensajes</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group">
                                        <!-- Mensajes se cargarán aquí por Socket.io -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title">Estadísticas</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <h6 class="text-muted">Usuarios Activos</h6>
                                            <h2 id="usuarios-activos" class="mb-0">1,024</h2>
                                        </div>
                                        <div class="col-6">
                                            <h6 class="text-muted">Crecimiento</h6>
                                            <h2 id="crecimiento-usuarios" class="mb-0">5%</h2>
                                        </div>
                                    </div>
                                    <div class="progress my-3" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" style="width: 75%; background-color: var(--success-color);" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <h6 class="text-muted">Mensajes Enviados</h6>
                                            <h2 id="mensajes-enviados" class="mb-0">3,456</h2>
                                        </div>
                                        <div class="col-6">
                                            <h6 class="text-muted">Crecimiento</h6>
                                            <h2 id="crecimiento-mensajes" class="mb-0">10%</h2>
                                        </div>
                                    </div>
                                    <div class="progress my-3" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" style="width: 85%; background-color: var(--info-color);" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
       // Socket.io connection
       const socket = io();
       
       // Actualizar estadísticas en tiempo real
       socket.on('estadisticasUpdate', function(data) {
           document.getElementById('usuarios-count').textContent = data.usuarios;
           document.getElementById('comunidades-count').textContent = data.comunidades;
           document.getElementById('mensajes-count').textContent = data.mensajes;
           document.getElementById('reportes-count').textContent = data.reportes;
       });
       
       // Chart.js configuration
       const ctx = document.getElementById('activityChart').getContext('2d');
       const activityChart = new Chart(ctx, {
           type: 'line',
           data: {
               labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
               datasets: [{
                   label: 'Usuarios Activos',
                   data: [12, 19, 15, 25, 22, 18, 24],
                   borderColor: '#3498db',
                   backgroundColor: 'rgba(52, 152, 219, 0.1)',
                   borderWidth: 3,
                   fill: true,
                   tension: 0.4
               }, {
                   label: 'Mensajes',
                   data: [5, 12, 8, 15, 18, 10, 20],
                   borderColor: '#27ae60',
                   backgroundColor: 'rgba(39, 174, 96, 0.1)',
                   borderWidth: 3,
                   fill: true,
                   tension: 0.4
               }]
           },
           options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                   legend: {
                       position: 'top',
                   }
               },
               scales: {
                   y: {
                       beginAtZero: true,
                       grid: {
                           color: 'rgba(0,0,0,0.1)'
                       }
                   },
                   x: {
                       grid: {
                           color: 'rgba(0,0,0,0.1)'
                       }
                   }
               }
           }
       });
       
       // Cambiar período del gráfico
       function cambiarPeriodo(periodo) {
           // Actualizar botones activos
           document.querySelectorAll('.btn-group .btn').forEach(btn => {
               btn.classList.remove('active');
           });
           event.target.classList.add('active');
           
           // Actualizar datos del gráfico
           let newLabels, newData1, newData2;
           
           switch(periodo) {
               case 'dia':
                   newLabels = ['0h', '4h', '8h', '12h', '16h', '20h', '24h'];
                   newData1 = [2, 5, 8, 15, 22, 18, 12];
                   newData2 = [1, 3, 6, 12, 18, 15, 8];
                   break;
               case 'semana':
                   newLabels = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
                   newData1 = [12, 19, 15, 25, 22, 18, 24];
                   newData2 = [5, 12, 8, 15, 18, 10, 20];
                   break;
               case 'mes':
                   newLabels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
                   newData1 = [85, 92, 78, 95];
                   newData2 = [45, 52, 38, 65];
                   break;
           }
           
           activityChart.data.labels = newLabels;
           activityChart.data.datasets[0].data = newData1;
           activityChart.data.datasets[1].data = newData2;
           activityChart.update();
       }
       
       // Ver mensaje detallado
       function verMensaje(id) {
           window.location.href = `/mensajes/${id}`;
       }
       
       // Actualizar estadísticas cada 5 minutos
       setInterval(() => {
           fetch('/api/estadisticas')
               .then(response => response.json())
               .then(data => {
                   document.getElementById('usuarios-count').textContent = data.usuarios;
                   document.getElementById('comunidades-count').textContent = data.comunidades;
                   document.getElementById('mensajes-count').textContent = data.mensajes;
                   document.getElementById('reportes-count').textContent = data.reportes;
               })
               .catch(error => console.error('Error actualizando estadísticas:', error));
       }, 300000); // 5 minutos
       
       // Animación de carga para las tarjetas
       document.addEventListener('DOMContentLoaded', function() {
           const cards = document.querySelectorAll('.card');
           cards.forEach((card, index) => {
               setTimeout(() => {
                   card.style.opacity = '0';
                   card.style.transform = 'translateY(30px)';
                   card.style.transition = 'all 0.5s ease';
                   
                   setTimeout(() => {
                       card.style.opacity = '1';
                       card.style.transform = 'translateY(0)';
                   }, 100);
               }, index * 100);
           });
       });
   </script>
   
   <!-- Sistema de Temas -->
   <script src="/js/theme-switcher.js"></script>
</body>
</html>