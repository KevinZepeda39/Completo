// diagnose-verification-issue.js - Diagn√≥stico avanzado del problema de verificaci√≥n
const mysql = require('mysql2/promise');

// Configuraci√≥n de la base de datos
const DB_CONFIG = {
  host: 'localhost',
  user: 'root',
  password: '',
  database: 'miciudadsv'
};

// Funci√≥n para conectar a la base de datos
async function connectToDatabase() {
  try {
    const connection = await mysql.createConnection(DB_CONFIG);
    console.log('‚úÖ Conexi√≥n a la base de datos establecida');
    return connection;
  } catch (error) {
    console.error('‚ùå Error conectando a la base de datos:', error.message);
    throw error;
  }
}

// Funci√≥n para verificar la estructura de la tabla usuarios
async function checkTableStructure(connection) {
  try {
    console.log('\nüîç === VERIFICANDO ESTRUCTURA DE TABLA ===');
    
    const [rows] = await connection.execute('DESCRIBE usuarios');
    console.log('üìã Estructura de la tabla usuarios:');
    
    rows.forEach(row => {
      console.log(`   - ${row.Field}: ${row.Type} ${row.Null === 'YES' ? '(NULL)' : '(NOT NULL)'} ${row.Default !== null ? `DEFAULT: ${row.Default}` : ''}`);
    });
    
    // Verificar si existe el campo emailVerificado
    const emailVerificadoField = rows.find(row => row.Field === 'emailVerificado');
    if (emailVerificadoField) {
      console.log('‚úÖ Campo emailVerificado encontrado');
      console.log(`   Tipo: ${emailVerificadoField.Type}`);
      console.log(`   Permite NULL: ${emailVerificadoField.Null}`);
      console.log(`   Valor por defecto: ${emailVerificadoField.Default}`);
    } else {
      console.log('‚ùå Campo emailVerificado NO encontrado');
    }
    
  } catch (error) {
    console.error('‚ùå Error verificando estructura de tabla:', error.message);
  }
}

// Funci√≥n para verificar usuarios con problemas de verificaci√≥n
async function checkUsersWithVerificationIssues(connection) {
  try {
    console.log('\nüë• === VERIFICANDO USUARIOS CON PROBLEMAS ===');
    
    // Buscar usuarios que se han registrado recientemente
    const [recentUsers] = await connection.execute(`
      SELECT 
        idUsuario,
        nombre,
        correo,
        emailVerificado,
        codigoVerificacion,
        codigoExpiracion,
        fechaCreacion,
        activo
      FROM usuarios 
      WHERE fechaCreacion >= DATE_SUB(NOW(), INTERVAL 1 DAY)
      ORDER BY fechaCreacion DESC
    `);
    
    if (recentUsers.length === 0) {
      console.log('üìÖ No hay usuarios registrados en las √∫ltimas 24 horas');
      return;
    }
    
    console.log(`üìÖ Usuarios registrados en las √∫ltimas 24 horas: ${recentUsers.length}`);
    
    recentUsers.forEach((user, index) => {
      console.log(`\nüë§ Usuario ${index + 1}:`);
      console.log(`   ID: ${user.idUsuario}`);
      console.log(`   Nombre: ${user.nombre}`);
      console.log(`   Email: ${user.correo}`);
      console.log(`   Email Verificado: ${user.emailVerificado} (tipo: ${typeof user.emailVerificado})`);
      console.log(`   C√≥digo Verificaci√≥n: ${user.codigoVerificacion || 'NULL'}`);
      console.log(`   C√≥digo Expiraci√≥n: ${user.codigoExpiracion || 'NULL'}`);
      console.log(`   Fecha Creaci√≥n: ${user.fechaCreacion}`);
      console.log(`   Activo: ${user.activo}`);
      
      // An√°lisis del problema
      if (user.emailVerificado == 0 || user.emailVerificado == false || user.emailVerificado == null) {
        console.log('   ‚ö†Ô∏è PROBLEMA: emailVerificado indica que NO est√° verificado');
      } else {
        console.log('   ‚úÖ emailVerificado indica que S√ç est√° verificado');
      }
      
      if (user.codigoVerificacion && user.codigoExpiracion) {
        const now = new Date();
        const expiration = new Date(user.codigoExpiracion);
        if (now > expiration) {
          console.log('   ‚ö†Ô∏è PROBLEMA: C√≥digo de verificaci√≥n expirado');
        } else {
          console.log('   ‚úÖ C√≥digo de verificaci√≥n v√°lido');
        }
      } else {
        console.log('   ‚ÑπÔ∏è Sin c√≥digo de verificaci√≥n activo');
      }
    });
    
  } catch (error) {
    console.error('‚ùå Error verificando usuarios:', error.message);
  }
}

// Funci√≥n para probar diferentes m√©todos de comparaci√≥n
async function testComparisonMethods(connection) {
  try {
    console.log('\nüß™ === PROBANDO M√âTODOS DE COMPARACI√ìN ===');
    
    // Obtener un usuario de ejemplo
    const [users] = await connection.execute(`
      SELECT idUsuario, nombre, correo, emailVerificado
      FROM usuarios 
      WHERE emailVerificado IS NOT NULL
      LIMIT 1
    `);
    
    if (users.length === 0) {
      console.log('‚ùå No hay usuarios para probar comparaciones');
      return;
    }
    
    const user = users[0];
    console.log(`üë§ Usuario de prueba: ${user.nombre} (${user.correo})`);
    console.log(`üìß emailVerificado en BD: ${user.emailVerificado} (tipo: ${typeof user.emailVerificado})`);
    
    // Probar diferentes m√©todos de comparaci√≥n
    console.log('\nüîç Resultados de comparaciones:');
    console.log(`   emailVerificado == 1: ${user.emailVerificado == 1}`);
    console.log(`   emailVerificado == true: ${user.emailVerificado == true}`);
    console.log(`   emailVerificado == "1": ${user.emailVerificado == "1"}`);
    console.log(`   emailVerificado === 1: ${user.emailVerificado === 1}`);
    console.log(`   emailVerificado === true: ${user.emailVerificado === true}`);
    console.log(`   emailVerificado === "1": ${user.emailVerificado === "1"}`);
    console.log(`   Boolean(emailVerificado): ${Boolean(user.emailVerificado)}`);
    console.log(`   !!emailVerificado: ${!!user.emailVerificado}`);
    console.log(`   String(emailVerificado): "${String(user.emailVerificado)}"`);
    
    // Probar la funci√≥n helper del servidor
    const isEmailVerified = (emailVerificado) => {
      if (emailVerificado === null || emailVerificado === undefined) {
        return false;
      }
      
      const value = String(emailVerificado).toLowerCase();
      const verifiedValues = ['1', 'true', 'yes', 'on'];
      
      return verifiedValues.includes(value) || Boolean(emailVerificado);
    };
    
    console.log(`\nüîß Funci√≥n helper isEmailVerified(): ${isEmailVerified(user.emailVerificado)}`);
    
  } catch (error) {
    console.error('‚ùå Error probando comparaciones:', error.message);
  }
}

// Funci√≥n para simular el flujo de verificaci√≥n
async function simulateVerificationFlow(connection) {
  try {
    console.log('\nüîÑ === SIMULANDO FLUJO DE VERIFICACI√ìN ===');
    
    // Buscar un usuario no verificado
    const [unverifiedUsers] = await connection.execute(`
      SELECT idUsuario, nombre, correo, emailVerificado, codigoVerificacion
      FROM usuarios 
      WHERE (emailVerificado = 0 OR emailVerificado = false OR emailVerificado IS NULL)
      AND codigoVerificacion IS NOT NULL
      LIMIT 1
    `);
    
    if (unverifiedUsers.length === 0) {
      console.log('‚ùå No hay usuarios no verificados con c√≥digo activo');
      return;
    }
    
    const user = unverifiedUsers[0];
    console.log(`üë§ Usuario no verificado: ${user.nombre} (${user.correo})`);
    console.log(`üîë C√≥digo actual: ${user.codigoVerificacion}`);
    
    // Generar c√≥digo de verificaci√≥n
    const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
    const expiration = new Date();
    expiration.setMinutes(expiration.getMinutes() + 10);
    
    // üî• CORREGIDO: Convertir a formato MySQL como lo hace el servidor
    const expirationMySQL = expiration.toISOString().slice(0, 19).replace('T', ' ');
    
    console.log(`   üîë Nuevo c√≥digo: ${verificationCode}`);
    console.log(`   ‚è∞ Expira en: ${expirationMySQL}`);
    
    // Actualizar usuario con nuevo c√≥digo
    await connection.execute(`
      UPDATE usuarios 
      SET codigoVerificacion = ?, codigoExpiracion = ?
      WHERE idUsuario = ?
    `, [verificationCode, expirationMySQL, user.idUsuario]);
    
    // Verificar el cambio
    const [updatedUsers] = await connection.execute(`
      SELECT emailVerificado, codigoVerificacion
      FROM usuarios 
      WHERE idUsuario = ?
    `, [user.idUsuario]);
    
    if (updatedUsers.length > 0) {
      const updatedUser = updatedUsers[0];
      console.log(`\nüîç Estado despu√©s de la actualizaci√≥n:`);
      console.log(`   emailVerificado: ${updatedUser.emailVerificado} (tipo: ${typeof updatedUser.emailVerificado})`);
      console.log(`   codigoVerificacion: ${updatedUser.codigoVerificacion}`);
      
      // Probar la funci√≥n helper nuevamente
      const isEmailVerified = (emailVerificado) => {
        if (emailVerificado === null || emailVerificado === undefined) {
          return false;
        }
        
        const value = String(emailVerificado).toLowerCase();
        const verifiedValues = ['1', 'true', 'yes', 'on'];
        
        return verifiedValues.includes(value) || Boolean(emailVerificado);
      };
      
      console.log(`\nüîß Funci√≥n helper isEmailVerified() despu√©s de actualizaci√≥n: ${isEmailVerified(updatedUser.emailVerificado)}`);
    }
    
  } catch (error) {
    console.error('‚ùå Error simulando verificaci√≥n:', error.message);
  }
}

// Funci√≥n principal
async function diagnoseVerificationIssue() {
  let connection;
  
  try {
    console.log('üîç === DIAGN√ìSTICO DEL PROBLEMA DE VERIFICACI√ìN ===');
    console.log('üìÖ Fecha y hora:', new Date().toLocaleString());
    
    // Conectar a la base de datos
    connection = await connectToDatabase();
    
    // Ejecutar diagn√≥sticos
    await checkTableStructure(connection);
    await checkUsersWithVerificationIssues(connection);
    await testComparisonMethods(connection);
    await simulateVerificationFlow(connection);
    
    console.log('\nüèÅ Diagn√≥stico completado');
    
  } catch (error) {
    console.error('üí• Error en el diagn√≥stico:', error.message);
  } finally {
    if (connection) {
      try {
        await connection.end();
        console.log('üîå Conexi√≥n a la base de datos cerrada');
      } catch (error) {
        console.error('‚ùå Error cerrando conexi√≥n:', error.message);
      }
    }
  }
}

// Ejecutar el diagn√≥stico
console.log('üöÄ Iniciando diagn√≥stico...');
diagnoseVerificationIssue().then(() => {
  console.log('\n‚úÖ Diagn√≥stico completado exitosamente');
  process.exit(0);
}).catch((error) => {
  console.error('\nüí• Diagn√≥stico fall√≥:', error.message);
  process.exit(1);
});
